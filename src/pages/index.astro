---
import OsLayout from "../layouts/OsLayout.astro";
import apps_raw from "../data/apps_manifest.json";

// Ensure assets are prefixed with BASE_URL if needed
const apps = apps_raw.map((app) => ({
  ...app,
  icon_path:
    app.icon.startsWith("/") || app.icon.startsWith("http") ? app.icon : null,
  lucide_icon:
    !app.icon.startsWith("/") && !app.icon.startsWith("http") ? app.icon : null,
}));
---

<OsLayout title="ShadowOS 3">
  <!-- Desktop Background -->
  <div
    id="desktop-surface"
    class="absolute inset-0 z-0 bg-cover bg-center bg-no-repeat overflow-hidden select-none tap-highlight-transparent"
    style={`background-image: url('${import.meta.env.BASE_URL}/wallpaper.png');`}
  >
    <!-- Overlay for better text readability -->
    <div class="absolute inset-0 bg-black/40 pointer-events-none"></div>

    <!-- Vignette -->
    <div
      class="absolute inset-0 bg-[radial-gradient(circle_at_center,transparent_0%,#000000_100%)] pointer-events-none opacity-70"
    >
    </div>

    <!-- Desktop Icons Container -->
    <div
      id="desktop-icons-container"
      class="absolute inset-0 z-10 p-4 pointer-events-auto overflow-y-auto sm:overflow-hidden grid grid-cols-3 sm:block gap-4"
    >
      <!-- Dynamic Icons will be injected here -->
    </div>

    <!-- Context Menu -->
    <div
      id="context-menu"
      class="fixed z-[10000] w-56 bg-slate-900/90 backdrop-blur-3xl border border-white/10 rounded-xl shadow-2xl py-2 text-slate-200 hidden select-none p-1.5"
    >
      <div
        class="menu-item px-3 py-1.5 flex items-center justify-between hover:bg-blue-600 hover:text-white cursor-pointer rounded-lg transition-colors group"
        data-action="new-folder"
      >
        <div class="flex items-center gap-2.5">
          <i
            data-lucide="folder-plus"
            class="w-4 h-4 text-blue-400 group-hover:text-white"></i>
          <span class="text-sm font-medium">Nouveau dossier</span>
        </div>
      </div>
      <div
        class="menu-item px-3 py-1.5 flex items-center justify-between hover:bg-blue-600 hover:text-white cursor-pointer rounded-lg transition-colors group"
        data-action="new-file"
      >
        <div class="flex items-center gap-2.5">
          <i
            data-lucide="file-plus"
            class="w-4 h-4 text-emerald-400 group-hover:text-white"></i>
          <span class="text-sm font-medium">Document texte</span>
        </div>
      </div>
      <div class="h-[1px] bg-white/5 my-2 mx-1"></div>
      <div
        class="menu-item px-3 py-1.5 flex items-center justify-between hover:bg-blue-600 hover:text-white cursor-pointer rounded-lg transition-colors group"
        data-action="rename"
      >
        <div class="flex items-center gap-2.5">
          <i
            data-lucide="edit-3"
            class="w-4 h-4 text-amber-400 group-hover:text-white"></i>
          <span class="text-sm font-medium">Renommer</span>
        </div>
      </div>
      <div
        class="menu-item px-3 py-1.5 flex items-center justify-between hover:bg-rose-600 hover:text-white cursor-pointer rounded-lg transition-colors group"
        data-action="delete"
      >
        <div class="flex items-center gap-2.5">
          <i
            data-lucide="trash-2"
            class="w-4 h-4 text-rose-500 group-hover:text-white"></i>
          <span class="text-sm font-medium">Supprimer</span>
        </div>
      </div>
      <div class="h-[1px] bg-white/5 my-2 mx-1"></div>
      <div
        class="menu-item px-3 py-1.5 flex items-center justify-between hover:bg-blue-600 hover:text-white cursor-pointer rounded-lg transition-colors group"
        data-action="copy"
      >
        <div class="flex items-center gap-2.5">
          <i
            data-lucide="copy"
            class="w-4 h-4 text-slate-400 group-hover:text-white"></i>
          <span class="text-sm font-medium">Copier</span>
        </div>
      </div>
      <div
        class="menu-item px-3 py-1.5 flex items-center justify-between hover:bg-blue-600 hover:text-white cursor-pointer rounded-lg transition-colors group"
        data-action="paste"
      >
        <div class="flex items-center gap-2.5">
          <i
            data-lucide="clipboard-paste"
            class="w-4 h-4 text-slate-400 group-hover:text-white"></i>
          <span class="text-sm font-medium">Coller</span>
        </div>
      </div>
    </div>

    <!-- Tray Menu -->
    <div
      id="tray-menu"
      class="fixed right-6 bottom-20 z-[10001] w-72 bg-slate-900/90 backdrop-blur-3xl border border-white/10 rounded-2xl shadow-[0_20px_60px_rgba(0,0,0,0.6)] hidden flex-col overflow-hidden p-6 transition-all scale-95 opacity-0"
    >
      <div class="flex flex-col gap-1 mb-6">
        <span
          id="tray-real-time"
          class="text-5xl font-black text-white tracking-tight">00:00:00</span
        >
        <span
          id="tray-date"
          class="text-lg font-bold text-blue-400 uppercase tracking-widest"
          >Lundi 1 Janvier</span
        >
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div
          class="bg-white/5 p-4 rounded-xl border border-white/5 flex flex-col gap-2"
        >
          <i data-lucide="wifi" class="w-5 h-5 text-emerald-400"></i>
          <span
            class="text-xs font-bold text-slate-400 uppercase tracking-tighter"
            >Connecté</span
          >
        </div>
        <div
          class="bg-white/5 p-4 rounded-xl border border-white/5 flex flex-col gap-2"
        >
          <i data-lucide="battery" class="w-5 h-5 text-amber-400"></i>
          <span
            class="text-xs font-bold text-slate-400 uppercase tracking-tighter"
            >100% stable</span
          >
        </div>
      </div>
    </div>

    <!-- Selection Box -->
    <div
      id="selection-box"
      class="fixed border border-blue-400/60 bg-blue-500/20 rounded-sm z-[9999] hidden pointer-events-none shadow-[0_0_15px_rgba(59,130,246,0.2)]"
    >
    </div>
  </div>

  <!-- Windows Container -->
  <div
    id="windows-container"
    class="absolute inset-0 pointer-events-none z-20 overflow-hidden"
  >
  </div>

  <!-- Dock -->
  <div
    class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 pointer-events-auto w-full max-w-fit px-4 sm:px-0"
  >
    <div
      class="taskbar h-14 bg-slate-900/60 backdrop-blur-3xl border border-white/10 rounded-xl flex items-center gap-1.5 px-3 shadow-[0_20px_50px_rgba(0,0,0,0.5)] mx-auto w-fit"
    >
      <!-- Start Button -->
      <button
        id="start-btn"
        class="w-11 h-11 flex items-center justify-center hover:bg-white/10 rounded-xl transition-all active:scale-95 group mr-1 relative overflow-hidden border border-white/10 bg-gradient-to-br from-slate-800 to-slate-900 shadow-xl p-1"
      >
        <div
          class="absolute inset-0 bg-gradient-to-tr from-blue-500/30 to-purple-500/30 opacity-0 group-hover:opacity-100 transition-opacity duration-500"
        >
        </div>
        <img
          src={`${import.meta.env.BASE_URL}/os-logo.png`}
          alt="Logo"
          class="w-7 h-7 relative z-10 brightness-200"
        />
      </button>

      <div class="h-7 w-[1px] bg-white/10 mx-0.5"></div>

      <!-- Dock Apps -->
      <div class="flex items-center gap-1.5" id="taskbar-apps">
        {
          apps.map((app) => (
            <button
              class="app-btn w-11 h-11 flex items-center justify-center hover:bg-white/10 rounded-xl transition-all active:scale-95 group relative border border-transparent hover:border-white/10"
              title={app.title}
              data-dock-id={app.id}
            >
              <div class="relative w-7 h-7 flex items-center justify-center">
                {app.icon_path ? (
                  <img
                    src={`${import.meta.env.BASE_URL}${app.icon_path}`}
                    alt=""
                    class="w-full h-full object-contain group-hover:scale-110 transition-transform duration-300"
                  />
                ) : (
                  <i
                    data-lucide={app.lucide_icon}
                    class={`w-full h-full text-white/60 group-hover:${app.color || "text-white"} transition-all duration-300 group-hover:scale-110`}
                  />
                )}
              </div>

              <div class="indicator absolute -bottom-1 left-1/2 -translate-x-1/2 w-1.5 h-1.5 bg-blue-500 rounded-full opacity-0 scale-50 transition-all duration-500 shadow-[0_0_12px_rgba(59,130,246,1)] z-10" />
            </button>
          ))
        }
      </div>

      <div class="h-7 w-[1px] bg-white/10 mx-1"></div>

      <!-- Clock Tray -->
      <button
        id="clock-btn"
        class="flex items-center gap-3 px-3 font-bold text-[13px] text-white/90 select-none min-w-[50px] justify-center bg-white/5 rounded-xl border border-white/5 h-10 hover:bg-white/10 active:scale-95 transition-all"
      >
        <span id="taskbar-time">00:00</span>
      </button>
    </div>
  </div>
</OsLayout>

<script is:inline define:vars={{ apps }}>
  (function () {
    // Shared State
    const state = {
      activeWindows: new Set(),
      focusedWindow: null,
      clipboard: null,
      baseUrl: window.location.pathname.replace(/\/$/, ""),
      isMobile: window.innerWidth < 640,
      desktopItems: [...apps.map((a, i) => ({ ...a }))],
      selectedItemId: null,
    };

    if (state.baseUrl.endsWith(".html"))
      state.baseUrl = state.baseUrl.substring(
        0,
        state.baseUrl.lastIndexOf("/"),
      );

    function updateTime() {
      const now = new Date();
      const timeEl = document.getElementById("taskbar-time");
      const trayTimeEl = document.getElementById("tray-real-time");
      const trayDateEl = document.getElementById("tray-date");
      if (timeEl)
        timeEl.textContent = now.toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
        });
      if (trayTimeEl)
        trayTimeEl.textContent = now.toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      if (trayDateEl)
        trayDateEl.textContent = now.toLocaleDateString("fr-FR", {
          weekday: "long",
          day: "numeric",
          month: "long",
        });
    }
    setInterval(updateTime, 1000);
    updateTime();

    const appsDef = {};
    apps.forEach((app) => {
      appsDef[app.id] = { ...app };
    });

    class ContextMenu {
      constructor() {
        this.menu = document.getElementById("context-menu");
        this.surface = document.getElementById("desktop-surface");
        this.init();
      }
      init() {
        this.surface.oncontextmenu = (e) => {
          if (state.isMobile) return;
          e.preventDefault();
          const icon = e.target.closest(".desktop-icon");
          state.selectedItemId = icon ? icon.dataset.appId : null;
          this.show(e.clientX, e.clientY);
        };
        document.onclick = () => this.hide();
        this.menu.onclick = (e) => e.stopPropagation();
        this.menu.querySelectorAll(".menu-item").forEach((item) => {
          item.onclick = (e) => {
            const action = item.dataset.action;
            this.handleAction(action);
            this.hide();
          };
        });
      }
      handleAction(action) {
        switch (action) {
          case "new-folder":
            window.dm.addItem("folder");
            break;
          case "new-file":
            window.dm.addItem("file");
            break;
          case "rename":
            window.dm.renameItem(state.selectedItemId);
            break;
          case "delete":
            window.dm.deleteItem(state.selectedItemId);
            break;
          case "copy":
            state.clipboard = state.selectedItemId;
            break;
          case "paste":
            if (state.clipboard) window.dm.pasteItem(state.clipboard);
            break;
        }
      }
      show(x, y) {
        this.menu.style.left = x + "px";
        this.menu.style.top = y + "px";
        this.menu.classList.remove("hidden");
      }
      hide() {
        this.menu.classList.add("hidden");
      }
    }

    class TrayManager {
      constructor() {
        this.btn = document.getElementById("clock-btn");
        this.menu = document.getElementById("tray-menu");
        this.init();
      }
      init() {
        this.btn.onclick = (e) => {
          e.stopPropagation();
          this.toggle();
        };
        document.addEventListener("click", () => this.hide());
        this.menu.onclick = (e) => e.stopPropagation();
      }
      toggle() {
        if (this.menu.classList.contains("hidden")) this.show();
        else this.hide();
      }
      show() {
        this.menu.classList.remove("hidden");
        setTimeout(() => {
          this.menu.classList.add("scale-100", "opacity-100");
          this.menu.classList.remove("scale-95", "opacity-0");
        }, 10);
      }
      hide() {
        this.menu.classList.add("scale-95", "opacity-0");
        this.menu.classList.remove("scale-100", "opacity-100");
        setTimeout(() => this.menu.classList.add("hidden"), 200);
      }
    }

    class DesktopManager {
      constructor() {
        this.container = document.getElementById("desktop-icons-container");
        this.selectionBox = document.getElementById("selection-box");
        this.isDragging = false;
        this.isSelecting = false;
        this.draggedItem = null;
        this.startPos = { x: 0, y: 0 };
        this.gridSize = state.isMobile ? { w: 90, h: 100 } : { w: 100, h: 110 };
        this.init();
      }

      init() {
        this.render();
        const surface = document.getElementById("desktop-surface");
        surface.onmousedown = (e) => {
          if (state.isMobile || e.button !== 0 || e.target !== surface) return;
          this.startSelection(e);
        };
        document.onmousemove = (e) => {
          if (this.isSelecting) this.updateSelection(e);
          if (this.isDragging) this.updateDragging(e);
        };
        document.onmouseup = () => {
          this.endSelection();
          this.endDragging();
        };
      }

      render() {
        this.container.innerHTML = "";
        const rows = Math.floor((window.innerHeight - 100) / this.gridSize.h);

        state.desktopItems.forEach((item, index) => {
          const icon = document.createElement("div");
          icon.dataset.appId = item.id;
          icon.className =
            "desktop-icon relative sm:absolute flex flex-col items-center gap-1 p-2 rounded-xl transition-all sm:w-[90px] cursor-pointer hover:bg-white/10 group select-none active:scale-95 border border-transparent hover:border-white/5 active:bg-white/20";

          if (!state.isMobile) {
            const col = Math.floor(index / rows);
            const row = index % rows;
            icon.style.left = (item.x || 30 + col * this.gridSize.w) + "px";
            icon.style.top = (item.y || 30 + row * this.gridSize.h) + "px";
          }

          const iconInner = document.createElement("div");
          iconInner.className =
            "w-14 h-14 rounded-xl flex items-center justify-center bg-gradient-to-br from-slate-800/80 to-slate-900/80 shadow-2xl border border-white/10 group-hover:border-blue-500/50 group-hover:scale-110 transition-all duration-300 text-white relative overflow-hidden backdrop-blur-sm";

          let iconHtml = "";
          const iconPath =
            item.icon?.startsWith("/") || item.icon?.startsWith("http")
              ? item.icon
              : null;
          const lucideIcon = !iconPath ? item.icon : null;

          if (iconPath) {
            iconHtml = `<img src="${state.baseUrl}${iconPath}" class="w-9 h-9 object-contain pointer-events-none" />`;
          } else {
            iconHtml = `<i data-lucide="${lucideIcon || "file"}" class="w-7 h-7 ${item.color || "text-white"}"></i>`;
          }
          iconInner.innerHTML = `<div class="absolute inset-0 bg-gradient-to-tr from-blue-500/10 to-transparent opacity-0 group-hover:opacity-100 transition-opacity"></div>${iconHtml}`;

          const label = document.createElement("span");
          label.className =
            "text-[11px] font-semibold text-white/90 drop-shadow-lg text-center leading-tight bg-black/50 px-2.5 py-1 rounded-full backdrop-blur-md group-hover:bg-blue-600 transition-all border border-white/10 group-hover:border-blue-400/50 truncate w-full shadow-lg";
          label.textContent = item.title;

          icon.appendChild(iconInner);
          icon.appendChild(label);

          if (!state.isMobile) this.makeDraggable(icon);
          icon.ondblclick = () => window.wm.openWindow(item.id);
          icon.onclick = (e) => {
            e.stopPropagation();
            this.selectIcon(icon);
          };

          if (state.isMobile) {
            icon.ontouchend = () => window.wm.openWindow(item.id);
          }

          this.container.appendChild(icon);
        });
        if (window.lucide) window.lucide.createIcons();
      }

      selectIcon(icon) {
        this.container
          .querySelectorAll(".desktop-icon")
          .forEach((i) =>
            i.classList.remove("bg-white/20", "border-white/30", "selected"),
          );
        icon.classList.add("bg-white/20", "border-white/30", "selected");
      }

      addItem(type) {
        const id = "new-" + Date.now();
        const newItem = {
          id,
          title: type === "folder" ? "Nouveau dossier" : "Nouveau document.txt",
          icon: type === "folder" ? "folder" : "file-text",
          color: type === "folder" ? "text-blue-400" : "text-slate-300",
          type: "internal",
        };
        state.desktopItems.push(newItem);
        this.render();
      }

      deleteItem(id) {
        if (!id) return;
        state.desktopItems = state.desktopItems.filter((i) => i.id !== id);
        this.render();
      }

      renameItem(id) {
        if (!id) return;
        const name = prompt("Entrez le nouveau nom :");
        if (name) {
          const item = state.desktopItems.find((i) => i.id === id);
          if (item) item.title = name;
          this.render();
        }
      }

      pasteItem(id) {
        const original =
          state.desktopItems.find((i) => i.id === id) ||
          apps.find((a) => a.id === id);
        if (original) {
          const copy = {
            ...original,
            id: original.id + "-copy-" + Date.now(),
            title: original.title + " (Copie)",
          };
          state.desktopItems.push(copy);
          this.render();
        }
      }

      makeDraggable(icon) {
        icon.onmousedown = (e) => {
          if (e.button !== 0) return;
          e.stopPropagation();
          this.startDragging(icon, e.clientX, e.clientY);
        };
      }

      startDragging(item, x, y) {
        this.isDragging = true;
        this.draggedItem = item;
        this.startPos = { x: x - item.offsetLeft, y: y - item.offsetTop };
        item.classList.add("z-50", "scale-105", "opacity-80");
        item.style.transition = "none";
      }

      updateDragging(e) {
        if (!this.isDragging || !this.draggedItem) return;
        let nx = e.clientX - this.startPos.x;
        let ny = e.clientY - this.startPos.y;
        nx = Math.max(0, Math.min(window.innerWidth - 90, nx));
        ny = Math.max(0, Math.min(window.innerHeight - 90, ny));
        this.draggedItem.style.left = nx + "px";
        this.draggedItem.style.top = ny + "px";
      }

      endDragging() {
        if (!this.isDragging || !this.draggedItem) return;
        const left = parseInt(this.draggedItem.style.left);
        const top = parseInt(this.draggedItem.style.top);
        const col = Math.round((left - 30) / this.gridSize.w);
        const row = Math.round((top - 30) / this.gridSize.h);

        const finalX = 30 + col * this.gridSize.w;
        const finalY = 30 + row * this.gridSize.h;

        this.draggedItem.style.transition =
          "all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)";
        this.draggedItem.style.left = finalX + "px";
        this.draggedItem.style.top = finalY + "px";

        const item = state.desktopItems.find(
          (i) => i.id === this.draggedItem.dataset.appId,
        );
        if (item) {
          item.x = finalX;
          item.y = finalY;
        }

        this.draggedItem.classList.remove("z-50", "scale-105", "opacity-80");
        this.isDragging = false;
        this.draggedItem = null;
      }

      startSelection(e) {
        this.isSelecting = true;
        this.selectionStart = { x: e.clientX, y: e.clientY };
        this.selectionBox.classList.remove("hidden");
        this.selectionBox.style.left = e.clientX + "px";
        this.selectionBox.style.top = e.clientY + "px";
        this.selectionBox.style.width = "1px";
        this.selectionBox.style.height = "1px";

        // Unselect everything when starting a new selection on desktop background
        this.container
          .querySelectorAll(".desktop-icon")
          .forEach((i) =>
            i.classList.remove("bg-white/20", "border-white/30", "selected"),
          );
      }

      updateSelection(e) {
        const cx = e.clientX,
          cy = e.clientY;
        const w = Math.abs(cx - this.selectionStart.x);
        const h = Math.abs(cy - this.selectionStart.y);
        const l = Math.min(cx, this.selectionStart.x);
        const t = Math.min(cy, this.selectionStart.y);
        this.selectionBox.style.width = w + "px";
        this.selectionBox.style.height = h + "px";
        this.selectionBox.style.left = l + "px";
        this.selectionBox.style.top = t + "px";

        this.container.querySelectorAll(".desktop-icon").forEach((icon) => {
          const rect = icon.getBoundingClientRect();
          if (
            l < rect.right &&
            l + w > rect.left &&
            t < rect.bottom &&
            t + h > rect.top
          ) {
            icon.classList.add("bg-white/20", "border-white/30", "selected");
          } else {
            icon.classList.remove("bg-white/20", "border-white/30", "selected");
          }
        });
      }

      endSelection() {
        this.isSelecting = false;
        this.selectionBox.classList.add("hidden");
      }
    }

    class WindowManager {
      constructor() {
        this.container = document.getElementById("windows-container");
        this.windows = new Map();
        this.zIndex = 2000;
        this.activeId = null;
        this.init();
      }

      init() {
        document.querySelectorAll(".app-btn").forEach((btn) => {
          btn.onclick = () => this.toggleWindow(btn.dataset.dockId);
        });
        const startBtn = document.getElementById("start-btn");
        if (startBtn) startBtn.onclick = () => this.toggleWindow("about");
      }

      async createWindow(id) {
        const app = appsDef[id] || state.desktopItems.find((i) => i.id === id);
        if (!app) return;
        const win = document.createElement("div");
        win.className =
          "window absolute bg-slate-900/95 backdrop-blur-3xl flex flex-col overflow-hidden transition-all duration-300 pointer-events-auto border border-white/10 shadow-[0_30px_100px_rgba(0,0,0,0.6)] rounded-xl opacity-0 scale-95";
        win.id = `win-${id}`;
        win.style.zIndex = ++this.zIndex;

        if (state.isMobile) {
          win.style.width = "100%";
          win.style.height = "calc(100% - 80px)";
          win.style.left = "0px";
          win.style.top = "0px";
          win.classList.add("mobile-fullscreen");
        } else {
          const w = Math.min(900, window.innerWidth - 40);
          const h = Math.min(600, window.innerHeight - 150);
          win.style.width = w + "px";
          win.style.height = h + "px";
          win.style.left = (window.innerWidth - w) / 2 + "px";
          win.style.top = (window.innerHeight - h) / 2 - 20 + "px";
        }

        win.innerHTML = `
          <div class="window-header h-11 bg-white/5 border-b border-white/5 flex items-center justify-between px-6 cursor-grab active:cursor-grabbing select-none relative z-40">
             <div class="flex items-center gap-3">
                <span class="text-xs font-black tracking-widest uppercase text-white/50">${app.title}</span>
             </div>
             <div class="flex items-center gap-2">
                <button class="win-btn min-btn w-3 h-3 rounded-full bg-amber-500/80 border border-amber-500/30 hover:scale-125 transition-all"></button>
                <button class="win-btn max-btn w-3 h-3 rounded-full bg-emerald-500/80 border border-emerald-500/30 hover:scale-125 transition-all ${state.isMobile ? "hidden" : ""}"></button>
                <button class="win-btn close-btn w-3 h-3 rounded-full bg-rose-500/80 border border-rose-500/30 hover:scale-125 transition-all"></button>
             </div>
          </div>
          <div class="window-content flex-1 relative overflow-hidden">
            <div class="p-10 text-center animate-pulse text-slate-500 font-mono">Chargement...</div>
          </div>
          <div class="resize-handle absolute right-0 bottom-0 w-4 h-4 cursor-se-resize z-50 ${state.isMobile ? "hidden" : ""}"></div>
        `;

        win.querySelector(".close-btn").onclick = () => this.closeWindow(id);
        win.querySelector(".min-btn").onclick = () => this.minimizeWindow(id);
        if (!state.isMobile)
          win.querySelector(".max-btn").onclick = () =>
            this.maximizeWindow(win);
        win.onmousedown = () => this.focusWindow(id);

        if (!state.isMobile) {
          this.makeDraggable(win);
          this.makeResizable(win);
        }

        this.container.appendChild(win);
        this.windows.set(id, win);
        this.updateDock(id, true);

        try {
          if (app.type === "iframe") {
            win.querySelector(".window-content").innerHTML =
              `<iframe src="${app.url}" class="w-full h-full border-none bg-white"></iframe>`;
          } else {
            const response = await fetch(
              `${state.baseUrl}/apps_content/${id}.html`,
            );
            if (response.ok) {
              const html = await response.text();
              win.querySelector(".window-content").innerHTML = html;
              if (window.lucide) window.lucide.createIcons();
            } else {
              win.querySelector(".window-content").innerHTML =
                `<div class="p-10 text-slate-400 font-mono text-center"><i data-lucide="info" class="w-12 h-12 mx-auto mb-4 opacity-20"></i><br/>Contenu vide ou application système "${id}".</div>`;
              if (window.lucide) window.lucide.createIcons();
            }
          }
        } catch (e) {
          win.querySelector(".window-content").innerHTML =
            `<div class="p-10 text-rose-500 font-mono">Erreur système.</div>`;
        }

        requestAnimationFrame(() => {
          win.classList.remove("opacity-0", "scale-95");
          this.focusWindow(id);
        });
      }

      openWindow(id) {
        let win = this.windows.get(id);
        if (!win) this.createWindow(id);
        else {
          win.style.display = "flex";
          setTimeout(() => {
            win.classList.remove("opacity-0", "scale-95");
            this.focusWindow(id);
          }, 10);
        }
      }

      toggleWindow(id) {
        const win = this.windows.get(id);
        if (!win || win.style.display === "none") this.openWindow(id);
        else
          this.activeId === id ? this.minimizeWindow(id) : this.focusWindow(id);
      }

      closeWindow(id) {
        const win = this.windows.get(id);
        if (win) {
          win.classList.add("opacity-0", "scale-95");
          setTimeout(() => {
            win.remove();
            this.windows.delete(id);
            this.updateDock(id, false);
          }, 300);
        }
      }

      minimizeWindow(id) {
        const win = this.windows.get(id);
        if (win) {
          win.classList.add("opacity-0", "scale-95");
          setTimeout(() => (win.style.display = "none"), 300);
        }
      }

      focusWindow(id) {
        const win = this.windows.get(id);
        if (win) {
          win.style.zIndex = ++this.zIndex;
          this.activeId = id;
        }
      }

      maximizeWindow(win) {
        if (win.classList.contains("maximized")) {
          win.classList.remove("maximized");
          win.style.width = win.dataset.pw;
          win.style.height = win.dataset.ph;
          win.style.left = win.dataset.pl;
          win.style.top = win.dataset.pt;
        } else {
          win.dataset.pw = win.style.width;
          win.dataset.ph = win.style.height;
          win.dataset.pl = win.style.left;
          win.dataset.pt = win.style.top;
          win.classList.add("maximized");
          win.style.width = "calc(100% - 20px)";
          win.style.height = "calc(100% - 110px)";
          win.style.left = "10px";
          win.style.top = "10px";
        }
      }

      makeDraggable(win) {
        const header = win.querySelector(".window-header");
        let dx,
          dy,
          dragging = false;
        header.onmousedown = (e) => {
          if (win.classList.contains("maximized")) return;
          dragging = true;
          dx = e.clientX - win.offsetLeft;
          dy = e.clientY - win.offsetTop;
          win.style.transition = "none";
        };
        window.addEventListener("mousemove", (e) => {
          if (dragging) {
            win.style.left = e.clientX - dx + "px";
            win.style.top = e.clientY - dy + "px";
          }
        });
        window.addEventListener("mouseup", () => {
          dragging = false;
          win.style.transition = "all 0.3s cubic-bezier(0.2, 0.8, 0.2, 1)";
        });
      }

      makeResizable(win) {
        const handle = win.querySelector(".resize-handle");
        let sw,
          sh,
          sx,
          sy,
          resizing = false;
        handle.onmousedown = (e) => {
          e.preventDefault();
          resizing = true;
          sw = win.offsetWidth;
          sh = win.offsetHeight;
          sx = e.clientX;
          sy = e.clientY;
        };
        window.addEventListener("mousemove", (e) => {
          if (resizing) {
            win.style.width = Math.max(350, sw + (e.clientX - sx)) + "px";
            win.style.height = Math.max(250, sh + (e.clientY - sy)) + "px";
          }
        });
        window.addEventListener("mouseup", () => (resizing = false));
      }

      updateDock(id, active) {
        const btn = document.querySelector(`.app-btn[data-dock-id="${id}"]`);
        const ind = btn?.querySelector(".indicator");
        if (ind) {
          if (active) {
            ind.classList.add("opacity-100", "scale-100");
            ind.classList.remove("opacity-0", "scale-50");
          } else {
            ind.classList.remove("opacity-100", "scale-100");
            ind.classList.add("opacity-0", "scale-50");
          }
        }
      }
    }

    function init() {
      if (!document.getElementById("desktop-surface")) return;
      window.wm = new WindowManager();
      window.dm = new DesktopManager();
      new ContextMenu();
      new TrayManager();
      if (window.lucide) window.lucide.createIcons();
    }
    document.addEventListener("DOMContentLoaded", init);
    document.addEventListener("astro:page-load", init);
  })();
</script>

<style>
  .window.maximized {
    border-radius: 0.75rem !important;
  }
  .window.mobile-fullscreen {
    border-radius: 0 !important;
    border-left: 0;
    border-right: 0;
    border-top: 0;
  }
  .window {
    transition:
      opacity 0.3s ease,
      transform 0.3s ease,
      width 0.3s cubic-bezier(0.2, 0.8, 0.2, 1),
      height 0.3s cubic-bezier(0.2, 0.8, 0.2, 1),
      left 0.3s cubic-bezier(0.2, 0.8, 0.2, 1),
      top 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
  }
  .indicator {
    box-shadow:
      0 0 10px #3b82f6,
      0 0 4px #3b82f6;
  }
  .desktop-icon.selected {
    background-color: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.25);
  }
</style>
